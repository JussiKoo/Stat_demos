---
title: "Bayes-tilastotiede 1 harjoitustyö"
author: "Jussi Kauppinen"
date: "`r Sys.Date()`"
output: bookdown::pdf_document2
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE
)
library(ggplot2)
library(brms)
library(bookdown)
library(patchwork)
library(scales)
```

```{r, include=FALSE}
siemenluku <- 8547 # LAITA TÄHÄN OPISKELIJANUMEROSI
# jos set.seed(siemenluku antaa virheilmoituksen), 
# vaihda siemenluvuksi opiskelijanumerosi neljä viimeistä numeroa
set.seed(siemenluku)
library("rlang")
library("haven")
library("tidyr")
library("dplyr")
library(knitr)

d <- read_spss("daF2076_eng.por") |> 
  select(
    arvosana = K82,
    sukupuoli = T3,
    koulutustaso = BV2_1,
    tulot = BV4_1,
    ITPA = L17,
  ) |> 
  mutate(
    sukupuoli = factor(sukupuoli, labels = c("Mies", "Nainen")),
    koulutustaso = recode_factor(
      factor(koulutustaso),
      "2" = "Korkeintaan toisen asteen koulutus",
      "3" = "Korkeintaan toisen asteen koulutus",
      "4" = "Korkeintaan toisen asteen koulutus",
      "5" = "Alempi korkeakouluaste tai alin korkea-aste",
      "6" = "Alempi korkeakouluaste tai alin korkea-aste",
      "7" = "Ylempi korkeakouluaste",
      "8" = "Ylempi korkeakouluaste"
    )
  ) |> 
  slice(sample(seq_len(n()), size = 300)) |> 
  # käytetään vain täysiä havaintorivejä yksinkertaisuuden vuoksi
  drop_na()
```

# Datan analysointia ja visualisointia

Aineistona tässä harjoitustyössä käytetään Elämänkulku 1971–2002 -aineistoa [@elama]. Tässä raportissa keskitytään tutkimaan peruskoulun keskiarvon, sukupuolen, ITPA-testituloksen ja koulutustason vaikutusta tuloihin. Havainnot saavat vain positiivisia arvoja ja pääasiassa paljon nollaa suurempia arvoja joten niiden voitaisiin ajatella olevan gamma-jakautuneita. Koska arvot ovat paljon nollasta poikkeavia voitaisiin mallinnusta yksinkertaistaa ajattelemalla, että havainnot ovat normaalijakautuneita. Kuvassa \@ref(fig:kuva2) on kuvattu eri selittäjien yhteyttä tuloihin. Näyttäisi siltä, että miehillä on keskimäärin naisia suuremmat tulot. Peruskoulun päättötodistuksen keskiarvolla vaikuttaa olevan melko samanlainen vaikutus molemmilla sukupuolilla eli keskiarvo näyttäisi kasvattavan tulotasoja maltillisen lineaarisesti. ITPA-älykkyystestin tuloksella ei näytä olevan suurta vaikutusta tuloihin. Koulutusasteella näyttää olevan olennainen vaikutus tuloihin vain ylemmän korkeakouluasteen ja muiden välillä.

```{r kuva1, fig.cap="Tulojen jakauma ja gamma-jakauma", fig.height=2.5, fig.width=4, include=FALSE}
ggplot(data=d, mapping=aes(tulot))+
  geom_density()+
  stat_function(fun = dgamma, args = list(shape = 10, rate = 10/18600), color = "blue", linewidth = 0.5)
#(shape-1)/rate = 18600
```

```{r kuva2, fig.cap="Eri selittäjien yhteys tuloihin"}
kuva1 <- ggplot(data=d, mapping=aes(x=sukupuoli, y=tulot))+
  geom_boxplot()

kuva2 <- ggplot(data=d, mapping=aes(x=arvosana, y=tulot, colour = sukupuoli))+
  geom_point(shape=20)

kuva3 <- ggplot(data=d, mapping=aes(x=ITPA, y=tulot))+
  geom_point(shape=20)

kuva4 <- ggplot(data=d, mapping=aes(x=koulutustaso, y=tulot))+
  geom_boxplot()+
  scale_x_discrete(labels = label_wrap(10))

(kuva1 | kuva2) / (kuva3 | kuva4)
```

# Mallintaminen

Mallinnetaan tuloja lineaarisella regressiomallilla. Oletetaan siis, että tuloille $y_i$ pätee $y_i|\mu_i,\sigma^2 \sim N(\mu_i, \sigma^2)$.

$$y_i = \beta_0 + \beta_1 arvosana + \beta_2 ITPA + \beta_3 sukupM + \beta_4ylempikk + \epsilon_i, \quad \epsilon_i \sim N(0, \sigma^2,) \quad i=1,...,n$$ 

Vertaillaan mallia 1 jossa on kaikki yllä mainitut selittäjät ja mallia 2 jossa ITPA on jätetty pois selittäjistä. Vertaillaan lisäksi mallia 2 tilanteessa jossa asetetaan priorit selittäjille ja tilanteessa jossa selittäjillä on oletuspriorit.

Voitaisiin ajatella, että päättötodistuksen keskiarvolla on keskimäärin kasvattava vaikutus tuloihin. Kerroin $\beta_1$ kuvaa siis yhden arvosanan nousun vaikutusta tuloihin ja suuruusluokkaa on hankala arvioida. Valitaan näillä perusteilla $\beta_1 \sim N(5000, 2500)$. ITPA-älykkyystestillä ei välttämät. Voisi ajatella, että sitä vastaava kerroin on lähellä nollaa joten valitaan $\beta_2 \sim N(0, 1000)$. On myös tunnettua, että miehillä on keskimäärin naisia suuremmat tulot joten asetetaan $\beta_3 \sim N(5000, 2500)$. Ylemmän korkeakoulututkinnon omaavien voisi myös olettaa tienaavan keskimäärin enemmän muihin verrattuna joten asetetaan $\beta_4 \sim N(10000, 5000)$. Asetetaan myös $\sigma \sim Gamma(500, 0.2)$ eli havaintotasollakin samat selittäjät omaavilla henkilöillä voisi olettaa olevan jonkun verran vaihtelua tuloissa. Asetetaan priori myös vakiotermille. Tilanteessa jossa henkilö on nainen jolla ei ole korkeakoulututkintoa ja hänen peruskoulun keskiarvonsa on 4 ja ITPA-testitulos on 21 (aineiston minimi) voisi olettaa, että hänen tulonsa ovat melko pienet. Asetetaan siis $\beta_0 \sim N(5000, 1000)$.

Ennen mallin sovittamista sukupuoli-muuttujan oletustasoksi on asetettu "Nainen". On luotu myös uusi muuttuja "ylempikk" joka saa arvon "Kyllä" jos henkilö on suorittanut ylemmän korkeakoulututkinnon ja muuten arvon "Ei". Peruskoulun keskiarvo on siirretty siten, että keskiarvo 4 vastaa lukua 0. ITPA on siirretty siten, että aineiston pienin arvo 21 vastaa lukua 0.

```{r message=FALSE, warning=FALSE}
d$sukupuoli <- relevel(d$sukupuoli, "Nainen")

d$ylempikk <- ifelse(d$koulutustaso == "Ylempi korkeakouluaste", "Kyllä", "Ei")

priors1 <- c(
  prior(normal(5000, 2500), class="b", coef="sukupuoliMies"),
  prior(normal(5000,2500), class="b", coef="IarvosanaM4"),
  prior(normal(10000, 5000), class="b", coef="ylempikkKyllä"),
  prior(normal(0, 1000), class="b", coef="IITPAM21"),
  prior(normal(5000, 500), class="b", coef="Intercept"),
  prior(gamma(500, 0.2), class="sigma")
)

fit1 <- brm(tulot ~ 0 + Intercept + I(arvosana-4) + I(ITPA-21) + sukupuoli + ylempikk,
            prior = priors1, data=d, refresh=0)
fit1

priors2 <- c(
  prior(normal(5000, 2500), class="b", coef="sukupuoliMies"),
  prior(normal(5000, 2500), class="b", coef="IarvosanaM4"),
  prior(normal(10000, 5000), class="b", coef="ylempikkKyllä"),
  prior(normal(5000, 1000), class="b", coef="Intercept")
  #prior(gamma(100, 0.04), class="sigma")
)

fit2 <- brm(tulot ~ 0 + Intercept + I(arvosana-4) + sukupuoli + ylempikk, prior = priors2,
            data=d, refresh=0)
fit2

fit2_default <- brm(tulot ~ 0 + Intercept + I(arvosana-4) + sukupuoli + ylempikk,
                    data=d, refresh=0)
fit2_default

#prioriennustejakaumaa varten
fit2_prior <- brm(tulot ~ 0 + Intercept + I(arvosana-4) + sukupuoli + ylempikk, 
                  prior = priors2, sample_prior = "only", data=d, refresh=0)

mean(apply(posterior_predict(fit2_prior), 1, max) > max(d$tulot))

#Mallien vertailu LOO-avulla
loo1 <- loo(fit1)
loo2 <- loo(fit2)

loo_compare(loo1, loo2)

loo2_default <- loo(fit2_default)

loo_compare(loo2, loo2_default)

plot(conditional_effects(fit2), points = TRUE)

get_prior(tulot ~ arvosana + ITPA + sukupuoli + ylempikk, data=d)

```

```{r Kaavio1, results='asis'}
kable(fixef(fit1), caption="Mallin 1 posteriorikeskiarvot")
```

```{r Kaavio2, results='asis'}
kable(loo_compare(loo1, loo2), caption = "ELPD-arvojen vertailu malleille 1 ja 2")
```


```{r fig.cap="Mallin 2 prioriennustejakaumia vs. havaintojen jakauma"}
#prioriennustejakaumia
pp_check(fit2_prior)
```



# Lähdeviitteet
