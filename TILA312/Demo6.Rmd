---
title: "Demo 6"
author: "Jussi Kauppinen"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Task 6.1

\begin{equation}
\begin{split}
L(\lambda_1,..., \lambda_k) &= \prod_{i=1}^k \frac{\lambda_i^{y_i}}{y_i !} e^{-\lambda_i}\\
l(\lambda_1,..., \lambda_k) &= \sum_{i=1}^k y_i \log \lambda_i -\lambda_i - \log y_i !\\
&= \sum_{i=1}^k y_i x_i^T \beta - e^{x_i^T \beta} - \log y_i !\\
\frac{\partial}{\partial \beta}  l(\beta) &= \sum_{i=1}^k y_i x_{ij} - x_{ij} e^{x_i^T \beta}\\
\end{split}
\end{equation}

Estimating equations

$$\sum_{i=1}^k y_i x_{ij} - x_{ij} e^{x_i^T \beta} = 0$$

## Task 6.2

```{r}
library(lattice)
Bfly <- read.table("http://users.jyu.fi/~knordhau/GLM2/perhoset.txt", header=TRUE)
Bfly$habitat <- factor(Bfly$habitat, levels=c("Short", "Mixed", "Tall", "Hayfield"))

Bfly$time <- Bfly$time-1 #Shift time by 1 for better interpretations
attach(Bfly)
head(Bfly)

xyplot(Colias ~ time|habitat, group=site, data=Bfly, type="b", layout=c(2,2))

#Habitat seems to have an effect on number of butterflies.

ag <- aggregate(Colias, by=list(building), FUN=mean)

xyplot(ag$x ~ ag$Group.1, data=Bfly, type="b")

#Percentage of built in area on site seems to have negative effect on number
#of butterflies

fit1 <- glm(Colias ~ time + habitat + building, data=Bfly, family=poisson)
fit2 <- glm(Colias ~ time * habitat + building, data=Bfly, family=poisson)
anova(fit2, fit1, test="Chisq")

summary(fit2)

#It would seem like interaction between time and habitat is necessary.

ex.data1 <- data.frame(time = c(0,1,2,3,4), habitat = rep("Short", 5), building = c(0,0,0,0,0))

ex.data2 <- data.frame(time = c(0,1,2,3,4), habitat = rep("Hayfield", 5), building = c(0,0,0,0,0))

p1 <- predict(fit2, ex.data1, type="response", se.fit=TRUE)
p2 <- predict(fit2, ex.data2, type="response", se.fit=TRUE)

plot(ex.data1$time, p1$fit, type="l", col="red", ylim=c(0,25))
lines(ex.data2$time, p2$fit, type="l", col="blue")

```


## Task 6.3

```{r}
b <- coef(fit2)
b

#exp(beta0) means the expected number of butterflies in the zero case
#(short habitat, year 1)
exp(b[1])

#exp(beta1) is the percentual change in number of butterflies in one year in
#short habitat

exp(b[2])

#percentual difference in number of butterflies between mixed and short habitat
#is exp(beta2)

exp(b[3])

```


## Task 6.4

```{r}
library(MASS)

fitnb <- glm.nb(Colias ~ time * habitat + building, data=Bfly)
coef(fitnb)
coef(fit2)
```

## Task 6.5

## Task 6.6


