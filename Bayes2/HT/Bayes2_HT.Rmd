---
title: "Bayes-tilastotiede 2 harjoitustyö"
author: "Jussi Kauppinen"
date: "`r Sys.Date()`"
output: bookdown::pdf_document2
bibliography: references.bib
lang: fi
header-includes: 
  - \usepackage{tikz}
  - \usetikzlibrary{arrows.meta}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE
)

options(knitr.kable.NA = "", knitr.fig.cap = "Kuva")
library(ggplot2)
library(brms)
library(bookdown)
library(patchwork)
library(scales)
library(rlang)
library(haven)
library(tidyr)
library(dplyr)
library(knitr)
library(xtable)
```
# Aineiston analysointia ja visualisointia

Tässä harjoitustyössä tullaan arvioimaan eri tekijöiden vaikutusta matkapuhelimen käyttöikään. Harjoitustyössä käytetään aineistona matkapuhelimen hankintaa käsittelevää kyselytutkimusta [@Karvanen_2014]. Kiinnostuksen kohteena olevat tekijät aineistossa ovat sukupuoli, ikä, maantieteellinen alue, matkapuhelimen merkki ja kotitalouden tulot. Entisen puhelimen käyttöikä saadaan aineistosta välisensuroituna, sillä vastaajat ovat ilmoittaneet matkapuhelinten hankinta-ajat tarkimmillaan kuukauden tarkkuudella. Esimerkiksi jos vastaaja olisi ilmoittanut, että hän on hankkinut entisen puhelimensa toukokuussa 2008 ja nykyisen puhelimen heinäkuussa 2009 niin olisi entisen puhelimen käyttöikä pienimmillään 13 kuukautta ja suurimmillaan 15 kuukautta.

```{r, inclue=FALSE}
library("dplyr")
library("ggplot2")
library("tidyr")
url <- "http://users.jyu.fi/~santikka/bayes2/data/mobile_phone_purchases.csv"
mobile <- read.csv2(url, header = TRUE)

monthdiff <- function(year1, month1, year2, month2) {
12 * (year2 - year1) + (month2 - month1)
}
# Q43 When did you purchase your current phone? Year of purchase (9999 = missing)
# Q44 When did you purchase your current phone? Month of purchase (13 = missing)
# Q45 When did you purchase your current phone? Season of purchase
# (1 = winter, 2 = spring, 3 = summer, 4 = autumn, 5 = missing)
#sukupuoli, ikä, maantieteellinen alue, matkapuhelimen merkki
mobile <- mobile |>
rename(
year_cur = Q43,
month_cur = Q44,
season_cur = Q45,
year_prev = Q48,
month_prev = Q49,
season_prev = Q50,
brand_prev = Q47,
sex = Sukup,
age = Ika,
region = Alue,
income = Tulot
) |>
mutate(
  sex = factor(sex, labels=c("Mies", "Nainen")),
  age = factor(age, labels=c("15-24", "25-34", "35-44", "45-54", "55-64", "65-79")),
  region = factor(region, labels=c("Helsinki-Uusimaa", "Etelä-Suomi", "Länsi-Suomi", "Itä- ja Pohjois-Suomi")),
  income = factor(income, labels=c("max 30 000 €", "30 001–50 000 €", "50 001–70 000 €", "min 70 000 €", "Eos")),
  brand_prev = ifelse(brand_prev %in% c(4,7), 6, brand_prev),
  brand_prev = factor(brand_prev, labels=c("Nokia", "Apple iPhone", "Samsung", "Sony Ericsson", "Muu")),
  
  
# 9999 denotes NA for year in the data,
  year_cur = na_if(year_cur, 9999),
  year_prev = na_if(year_prev, 9999),

# month_min and max are helper variables used to determine the
# first or last possible month based on the season if month is NA
month_min_cur = month_cur - 1,
month_max_cur = month_cur,
month_min_prev = month_prev - 1,
month_max_prev = month_prev,

# 13 indicates NA for month, 5 indicates NA for season
month_min_cur = case_when(
month_cur == 13 & season_cur == 1 ~ 0,
month_cur == 13 & season_cur == 2 ~ 3,
month_cur == 13 & season_cur == 3 ~ 6,
month_cur == 13 & season_cur == 4 ~ 9,
month_cur == 13 & season_cur == 5 ~ 0,
.default = month_min_cur
),
month_max_cur = case_when(
month_cur == 13 & season_cur == 1 ~ 3,
month_cur == 13 & season_cur == 2 ~ 6,
month_cur == 13 & season_cur == 3 ~ 9,
month_cur == 13 & season_cur == 4 ~ 12,
month_cur == 13 & season_cur == 5 ~ 12,
.default = month_max_cur
),
month_min_prev = case_when(
month_prev == 13 & season_prev == 1 ~ 0,
month_prev == 13 & season_prev == 2 ~ 3,
month_prev == 13 & season_prev == 3 ~ 6,
month_prev == 13 & season_prev == 4 ~ 9,
month_prev == 13 & season_prev == 5 ~ 0,
.default = month_min_prev
),
month_max_prev = case_when(
month_prev == 13 & season_prev == 1 ~ 3,
month_prev == 13 & season_prev == 2 ~ 6,
month_prev == 13 & season_prev == 3 ~ 9,
month_prev == 13 & season_prev == 4 ~ 12,
month_prev == 13 & season_prev == 5 ~ 12,
.default = month_max_prev
),

#Min and max months between previous and current phone
ict_min = monthdiff(year_prev, month_max_prev, year_cur, month_min_cur),
ict_max = monthdiff(year_prev, month_min_prev, year_cur, month_max_cur),

# Enforce sanity of responses (max must be larger than min)
ict_min = case_when(
ict_min <= 0 | is.na(ict_min) ~ 0.1, # There must be a slight difference
.default = ict_min
),
ict_max = case_when(
ict_max <= 0 | is.na(ict_max) ~ 200, # The absolute maximum time (decided),
.default = ict_max
),

# Transformation into years
ict_min = ict_min / 12,
ict_max = ict_max / 12,
ict_mean = (ict_max + ict_min)/2
)

# Empirical cumulative distribution functions
it <- seq(0, 17, by = 0.05)
d1 <- data.frame(
it = c(it, it),
ecdf = c(ecdf(mobile$ict_max)(it), ecdf(mobile$ict_min)(it)),
time = gl(2, length(it), labels = c("max", "min"))
)

# Empirical density functions
d2 <- mobile |>
select(ict_min, ict_max) |>
pivot_longer(cols = everything(),
names_pattern = "ict_(.+)",
names_to = "time",
values_to = "ict"
)
```

```{r Aika, fig.cap="Ostotapahtumien välinen aika"}
ggplot(d1, aes(x = it, y = ecdf, colour = time)) +
geom_line() +
xlab("Time between purchases (years)") +
ylab("Cumulative density") +
theme_bw()

ggplot(d2, aes(x = ict, y = after_stat(density), colour = time)) +
geom_density() +
xlab("Time between purchases (years)") +
theme_bw()
```

# Mallintaminen

Sovitetaan aineistoon vastaavanlainen malli kuin alkuperäisessä tutkimuksessa. Mallin matemattinen rakenne voidaan kuvata siis seuraavasti:

\begin{equation}
  \begin{split}
    &t_i \in [t_i^{min},t_i^{max}],\\
    &t_i \sim Gamma(\alpha, \theta_i),\\
    &\alpha \sim Gamma(1,1),\\
    &\log(\theta_i) = \beta_0 + \beta_{1[i]} + \beta_{2[i]} + \beta_{3[i]} + \beta_{4[i]} +             \beta_{5[i]}\\
    \beta \sim N(0,1000)\\
  \end{split}
\end{equation}

Nyt kertoimet $\beta_{j[i]}$ määräytyvät vastaajan $i$ ominaisuuksien perusteella. Jokaiselle parametrille $\beta$ asetetaan heikosti informatiivinen priori $N(0,1000)$.

| Parametri      | Selitys           |
|----------------|-------------------|
| $\beta_{1[i]}$ | Sukupuoli         |
| $\beta_{2[i]}$ | Ikäryhmä          |
| $\beta_{3[i]}$ | Tuloluokka        |
| $\beta_{4[i]}$ | Alue              |
| $\beta_{5[i]}$ | Puhelimen merkki  |

Mallin hierarkinen rakenne on kuvattu kuvassa x. 

```{r DAG, echo=FALSE, fig.cap="Mallin DAG-kuvaaja", out.width='70%', out.height='70%', dev='svg', fig.align='center'}
knitr::include_graphics("Bayes_dag.svg")
```

```{r}
library(rstan)

scode <- "
data{
  int<lower=0> n;
  real<lower=0> t_max[n];
  real<lower=0> t_min[n];
  int<lower=0, upper=5> age;
  int<lower=0, upper=1> sex;
  int<lower=0, upper=3> region;
  int<lower=0, upper=4> brand;
  int<lower=0, upper=4> income;
}
parameters{
  real<lower=0, upper=1> t_init[n];
  
  real beta_female;
  real beta_25_34;
  real beta_35_44;
  real beta_45_54;
  real beta_55_64;
  real beta_65_79;
  real beta_south;
  real beta_west;
  real beta_east_north;
  real beta_iphone;
  real beta_samsung;
  real beta_sony_erics;
  real beta_other_brand;
  real beta_30k_50k;
  real beta_50k_70k;
  real beta_min70k;
  real beta_income_na;
  real<lower=0> alpha;
  real<lower=0> theta[n];
}
transformed parameters{
  //skaalataan t annetuille väleille
  real<lower=0> t[n];
  for (i in 1:n){
    t[i] = t_min[i] + t_init[i]*(t_max[i] - t_min[i]);
  }
}
model{
  alpha ~ gamma(1,1);
  
  beta_female ~ normal(0, 1000);
  beta_25_34 ~ normal(0, 1000);
  beta_35_44 ~ normal(0, 1000);
  beta_45_54 ~ normal(0, 1000);
  beta_55_64 ~ normal(0, 1000);
  beta_65_79 ~ normal(0, 1000);
  beta_south ~ normal(0, 1000);
  beta_west ~ normal(0, 1000);
  beta_east_north ~ normal(0, 1000);
  beta_iphone ~ normal(0, 1000);
  beta_samsung ~ normal(0, 1000);
  beta_sony_erics ~ normal(0, 1000);
  beta_other_brand ~ normal(0, 1000);
  beta_30k_50k ~ normal(0, 1000);
  beta_50k_70k ~ normal(0, 1000);
  beta_min70k ~ normal(0, 1000);
  beta_income_na ~ normal(0, 1000);
  
  t ~ gamma(alpha, theta);
  
}"

X <- model.matrix(~ sex + age + income + brand_prev + region, data=mobile)
dim(X)

fit <- stan(
  model_code = scode,
  data = list(
    n = nrow(mobile),
    t_max = mobile$ict_max,
    t_min = mobile$ict_min,
    age = mobile$age,
    sex = mobile$sex,
    income = mobile$income,
    region = mobile$region,
    brand = mobile$brand_prev
  ),
  iter = 4000,
  refresh = FALSE
)
```


# Tulokset

# Tulkinnat

# Pohdintaa

 

# Lähdeviitteet
